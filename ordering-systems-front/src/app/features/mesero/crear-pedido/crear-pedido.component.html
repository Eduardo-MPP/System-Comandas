<app-navbar></app-navbar>
<div class="crear-pedido-container">
    <div class="main-content">
        <!-- Menú de productos -->
        <div class="menu-section">
            <div class="section-header">
                <h2>Menú</h2>
                <div class="search-box">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" placeholder="Buscar productos..." [(ngModel)]="searchTerm" />
                </div>
            </div>
            <div class="category-filters">
                <button *ngFor="let cat of categories" [class.active]="selectedCategory === cat"
                    (click)="selectedCategory = cat" class="category-btn">
                    {{ cat }}
                </button>
            </div>
            <div class="menu-grid" *ngIf="!isLoading">
                <div *ngFor="let item of filteredMenuItems" class="menu-item-card" (click)="addToCart(item)">
                    <div class="item-info">
                        <h3>{{ item.name }}</h3>
                        <p class="item-description">{{ item.description }}</p>
                        <div class="item-footer">
                            <span class="item-price">S/ {{ item.price.toFixed(2) }}</span>
                            <span class="item-category">{{ item.categoryName }}</span>
                        </div>
                    </div>
                    <button class="btn-add">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="empty-menu" *ngIf="!isLoading && filteredMenuItems.length === 0">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
                <p>No se encontraron productos</p>
            </div>
        </div>
        <!-- Carrito -->
        <div class="cart-section">
            <div class="cart-header">
                <h2>Pedido</h2>
                <span class="cart-badge" *ngIf="cart.length > 0">{{ cartItemCount }}</span>
                <div *ngIf="currentOrder">
                    <span class="pedido-id">Pedido #{{ currentOrder.id }}</span>
                    <span *ngIf="currentOrder.status === 'ESPERANDO_CUENTA' || currentOrder.status === 'PAGADO'" class="pedido-estado">
                        (Cuenta solicitada o pagada)
                    </span>
                </div>
            </div>
            <div class="guest-input">
                <label>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Comensales
                </label>
                <input type="number" min="1" [(ngModel)]="numberOfGuests" class="guest-number" [disabled]="!!currentOrder"/>
            </div>
            <div class="cart-items" *ngIf="cart.length > 0">
                <div *ngFor="let item of cart; let i = index" class="cart-item">
                    <div class="item-details">
                        <h4>{{ item.menuItem.name }}</h4>
                        <p class="item-unit-price">S/ {{ item.menuItem.price.toFixed(2) }}</p>
                        <input type="text" placeholder="Notas adicionales..." [(ngModel)]="item.notes"
                            class="item-notes" />
                    </div>
                    <div class="item-controls">
                        <div class="quantity-controls">
                            <button (click)="updateQuantity(item, -1)" class="qty-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                            <span class="quantity">{{ item.quantity }}</span>
                            <button (click)="updateQuantity(item, 1)" class="qty-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="item-subtotal">
                            S/ {{ (item.menuItem.price * item.quantity).toFixed(2) }}
                        </div>
                        <button (click)="removeFromCart(i)" class="btn-remove">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="cart-empty" *ngIf="cart.length === 0">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <p>El carrito está vacío</p>
                <span>Agrega productos del menú</span>
            </div>
            <div class="cart-summary" *ngIf="cart.length > 0">
                <div class="summary-row">
                    <span>Total</span>
                    <strong class="total-amount">S/ {{ cartTotal.toFixed(2) }}</strong>
                </div>
            </div>
            <div class="cart-actions">
                <button (click)="submitOrder()"
                    [disabled]="cart.length === 0 || isSubmitting || (currentOrder?.status === 'ESPERANDO_CUENTA' || currentOrder?.status === 'PAGADO')"
                    class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    {{ isSubmitting ? 'Enviando...' : currentOrder ? 'Agregar Comanda' : 'Confirmar Pedido' }}
                </button>
                <button (click)="cancel()" class="btn-cancel">Cancelar</button>
            </div>
            <!-- BOTÓN PEDIR CUENTA -->
            <div class="pedir-cuenta-row" *ngIf="currentOrder && currentOrder.status !== 'ESPERANDO_CUENTA' && currentOrder.status !== 'PAGADO'">
                <button (click)="pedirCuenta()" class="btn-pedir-cuenta">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="6" width="20" height="12" rx="2" ry="2"></rect>
                        <line x1="8" y1="10" x2="16" y2="10"></line>
                        <line x1="8" y1="14" x2="16" y2="14"></line>
                    </svg>
                    Pedir cuenta
                </button>
            </div>
            <div *ngIf="currentOrder?.status === 'ESPERANDO_CUENTA'" class="estado-info">
                <span>La cuenta ha sido solicitada, espera al cajero.</span>
            </div>
            <div *ngIf="currentOrder?.status === 'PAGADO'" class="estado-info">
                <span>El pedido está pagado. La mesa será liberada en breve.</span>
            </div>
        </div>
    </div>
</div>
